<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Simple Calendar App</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>

<div id="calendar-container">
  <div id="calendar-header" class="calendar-header"></div>
  <div class="calendar-grid">
    <!-- Day Name Headers (Sun, Mon, etc.) -->
    <div class="day-header">Sun</div>
    <div class="day-header">Mon</div>
    <div class="day-header">Tue</div>
    <div class="day-header">Wed</div>
    <div class="day-header">Thu</div>
    <div class="day-header">Fri</div>
    <div class="day-header">Sat</div>
  </div>

  <!-- The grid of actual days (dates) will be inserted here by JS -->
  <div id="calendar-days" class="calendar-grid"></div>
</div>

<script>

var CALENDARS = [
  {
    id: "ronward.english@gmail.com",
    label: "BS",
    color: "blue"
  },
  {
    id: "c_1au77uvsbhjjkbbn0u0o1nvfdo@group.calendar.google.com",
    label: "杉並",
    color: "orange"
  }
];

// Replace with your Google API key
var API_KEY = "AIzaSyAJkLCd0IJ2dPxLeijCUO7HClOwSoy5j-Q";

/**
 * Create a simple monthly calendar and fetch events from Google Calendar.
 * This is set up for older iOS devices, so we're using ES5 syntax and XHR.
 */
(function() {
  // Get today's date
  var today = new Date();
  var currentYear = today.getFullYear();
  var currentMonth = today.getMonth(); // 0-based (0 = January)
  
  // Populate the header text (e.g., "January 2025")
  var headerEl = document.getElementById("calendar-header");
  var monthNames = [
    "January", "February", "March", "April", "May", "June", 
    "July", "August", "September", "October", "November", "December"
  ];
  headerEl.textContent = monthNames[currentMonth] + " " + currentYear;

  // Build the monthly calendar structure (empty boxes + date numbers)
  var calendarDaysEl = document.getElementById("calendar-days");
  // Clear any existing HTML
  calendarDaysEl.innerHTML = "";

  // Create a date for the first day of this month
  var firstDayOfMonth = new Date(currentYear, currentMonth, 1);
  // Find the day of the week the first day falls on (0=Sun, 1=Mon, etc.)
  var startDay = firstDayOfMonth.getDay();

  // Number of days in this month
  var daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

  // We need a total of (startDay) blank cells + (daysInMonth) real day cells
  // Then if the last day doesn't end on Saturday, we may add some blank cells at the end.
  
  // First, add blank cells for days before 1st of the month
  var i;
  for (i = 0; i < startDay; i++) {
    var blankCell = document.createElement("div");
    blankCell.className = "day-cell";
    calendarDaysEl.appendChild(blankCell);
  }

  // Next, add cells for each day of the month
  for (i = 1; i <= daysInMonth; i++) {
    var dayCell = document.createElement("div");
    dayCell.className = "day-cell";

    // Show the day number
    var dayNumber = document.createElement("span");
    dayNumber.className = "day-number";
    dayNumber.textContent = i;
    dayCell.appendChild(dayNumber);

    calendarDaysEl.appendChild(dayCell);
  }

  /**
   * Now fetch events from Google Calendar for the current month.
   * We’ll filter events to only show those within this month.
   */
  var startDate = new Date(currentYear, currentMonth, 1);
  var endDate = new Date(currentYear, currentMonth + 1, 0, 23, 59, 59);

  // Format to RFC3339 for Google API:
// e.g., 2025-01-01T00:00:00Z
function toRFC3339(dateObj) {
  return dateObj.getFullYear() + "-" +
    pad(dateObj.getMonth() + 1) + "-" +
    pad(dateObj.getDate()) + "T" +
    pad(dateObj.getHours()) + ":" +
    pad(dateObj.getMinutes()) + ":" +
    pad(dateObj.getSeconds()) + "Z";
}

function pad(num) {
  return (num < 10 ? "0" : "") + num;
}

// Build RFC3339 dates for the current month
var timeMin = toRFC3339(startDate);
var timeMax = toRFC3339(endDate);

// Fetch events for each calendar in CALENDARS
fetchEventsForAllCalendars();

/**
 * Loops through each calendar in CALENDARS and fetches events.
 */
function fetchEventsForAllCalendars() {
  for (var i = 0; i < CALENDARS.length; i++) {
    fetchEventsForOneCalendar(CALENDARS[i]);
  }
}

/**
 * Fetches events for a single calendar object (which contains id, label, color).
 */
function fetchEventsForOneCalendar(calendar) {
  var url = "https://www.googleapis.com/calendar/v3/calendars/" +
    encodeURIComponent(calendar.id) +
    "/events?key=" + API_KEY +
    "&timeMin=" + timeMin +
    "&timeMax=" + timeMax +
    "&singleEvents=true&orderBy=startTime";

  var xhr = new XMLHttpRequest();
  xhr.open("GET", url, true);
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4 && xhr.status === 200) {
      var data = JSON.parse(xhr.responseText);
      if (data && data.items) {
        // Pass the calendar object so we know which label/color to use
        renderEvents(data.items, calendar);
      }
    }
  };
  xhr.send();
}

/**
 * Renders events in the calendar.
 * @param {Array} items - Events from the Google Calendar API.
 * @param {Object} calendar - The calendar object {id, label, color}.
 */
function renderEvents(items, calendar) {
  for (var i = 0; i < items.length; i++) {
    var ev = items[i];
    // All-day events have `ev.start.date`, timed events have `ev.start.dateTime`
    var startStr = ev.start.date || ev.start.dateTime;
    var eventDate = new Date(startStr);
    var day = eventDate.getDate();

    // cellIndex is offset by startDay
    var cellIndex = startDay + day - 1;
    var dayCells = calendarDaysEl.getElementsByClassName("day-cell");

    if (cellIndex >= 0 && cellIndex < dayCells.length) {
      var eventEl = document.createElement("div");
      eventEl.className = "event";
      
      // Use the calendar's label instead of the actual event summary
      eventEl.textContent = calendar.label;
      // Add a colored border based on the calendar.color
      eventEl.style.borderLeft = "3px solid " + calendar.color;
      eventEl.style.background = "#fff"; // Or keep it as you like

      dayCells[cellIndex].appendChild(eventEl);
    }
  }
}

})();

</script>

</body>
</html>
